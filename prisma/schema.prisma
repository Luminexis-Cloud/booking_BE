generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String   @id @default(cuid())
  name      String   @unique
  domain    String?
  userLimit Int      @default(100)
  users     User[]
  stores    Store[]
  roles     Role[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  email       String   @unique
  phoneNumber String   @unique
  password    String
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  storeId String?
  store   Store?  @relation("StoreToEmployees", fields: [storeId], references: [id])

  roleId String?
  role   Role?   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  refreshTokens   RefreshToken[]
  userPermissions UserPermission[]

  // user-to-user visibility
  visibleEmployeeLinks EmployeeVisibility[] @relation("Viewer")
  visibleToLinks       EmployeeVisibility[] @relation("Target")

  // store manager
  managedStores Store[] @relation("StoreToManager")

  // FIX: Add inverse relation for RoleUserVisibility
  roleVisibilityTargets RoleUserVisibility[] @relation("RoleVisibilityTarget")

  @@map("users")
}

model Store {
  id         String   @id @default(cuid())
  name       String   @unique
  areaOfWork String
  teamSize   Int
  date       String
  signature  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  companyId  String
  managerId  String?

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager   User?   @relation("StoreToManager", fields: [managerId], references: [id])
  employees User[]  @relation("StoreToEmployees")

  @@map("stores")
}

model EmployeeVisibility {
  id       String @id @default(cuid())
  viewerId String
  targetId String

  viewer User @relation("Viewer", fields: [viewerId], references: [id], onDelete: Cascade)
  target User @relation("Target", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([viewerId, targetId])
  @@map("employee_visibility")
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  userLimit       Int?             @default(10)
  companyId       String?
  company         Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users           User[]
  rolePermissions RolePermission[]

  // NEW — role-level user visibility rules
  visibilityRules RoleUserVisibility[]
}

model RoleUserVisibility {
  id       String @id @default(cuid())
  roleId   String
  targetId String

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // FIX → Add relation name: "RoleVisibilityTarget"
  target User @relation("RoleVisibilityTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([roleId, targetId])
  @@map("role_user_visibility")
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  module          String
  action          String
  description     String?
  rolePermissions RolePermission[]
  userPermissions UserPermission[]
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum PermissionEffect {
  ALLOW
  DENY
}

model UserPermission {
  id           String           @id @default(cuid())
  userId       String
  permissionId String
  effect       PermissionEffect

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
}

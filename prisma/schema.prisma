// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  firstName     String
  lastName      String
  email         String   @unique
  phoneNumber   String   @unique
  password      String
  isActive      Boolean  @default(true)
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Auth/session
  refreshTokens RefreshToken[]

  // Ownership
  stores        Store[]
  clients       Client[]

  // RBAC
  roleId String?
  role   Role?    @relation(fields: [roleId], references: [id])

  // Per-user permission overrides (optional; default none)
  userPermissions UserPermission[]

  // Visibility list
  // Users that THIS user can see:
  visibleEmployeeLinks EmployeeVisibility[] @relation("Viewer")
  // Users that can see THIS user:
  visibleToLinks       EmployeeVisibility[] @relation("Target")

  @@map("users")
}

model EmployeeVisibility {
  // viewer can see target
  id       String @id @default(cuid())
  viewerId String
  targetId String

  viewer User @relation("Viewer", fields: [viewerId], references: [id], onDelete: Cascade)
  target User @relation("Target", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([viewerId, targetId])
  @@map("employee_visibility")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model OtpCode {
  id          String   @id @default(cuid())
  code        String
  phoneNumber String
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@map("otp_codes")
}

model Store {
  id          String    @id @default(cuid())
  name        String
  areaOfWork  String
  teamSize    Int
  date        String
  signature   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  services    Service[]
  categories  Category[]
  clients     Client[]

  @@map("stores")
}

model Service {
  id              String   @id @default(cuid())
  serviceId       String   @unique @default(cuid()) @map("serviceid")
  name            String
  description     String?
  durationMinutes Int
  price           Json
  colorHex        String?
  deposit         Json
  isActive        Boolean  @default(true)
  date            String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  storeId         String   @map("storeId")
  categoryId      String   @map("categoryid")
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("services")
}

model Category {
  id          String    @id @default(cuid())
  categoryId  String    @unique @default(cuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  services    Service[]

  @@map("categories")
}

model Appointment {
  id          String   @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  type        String   @default("general")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("appointments")
}

model Client {
  id          String   @id @default(cuid())
  clientId    String   @unique @default(cuid())
  name        String
  phone       String
  email       String?
  notes       String?
  birthday    DateTime?
  information Json?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  storeId     String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("clients")
}

// --- RBAC ---

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  userLimit       Int?             @default(10)
  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid())
  // e.g. "Employees_view_all"
  name            String           @unique
  module          String           // Employees | Appointments | Services | Clients | Invoices | Reports
  action          String           // view_all | edit_other | add | edit | edit_past | add_edit | view | view_phone_numbers
  description     String?
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// OPTIONAL: per-user overrides (ALLOW/DENY)
enum PermissionEffect {
  ALLOW
  DENY
}

model UserPermission {
  id           String            @id @default(cuid())
  userId       String
  permissionId String
  effect       PermissionEffect  // ALLOW or DENY
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission   @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("user_permissions")
}

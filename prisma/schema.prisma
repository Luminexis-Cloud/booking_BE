generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// =========================
//        COMPANY
// =========================
//

model Company {
  id               String  @id @default(cuid())
  name             String  @unique
  signatureName    String?
  country          String?
  industry         String?
  teamMembersCount Int?
  domain           String?
  userLimit        Int     @default(100)

  users  User[]
  stores Store[]
  roles  Role[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// =========================
//          USER
// =========================
//
enum UserType {
    SUPERADMIN,
    EMPLOYEE
  }
  
model User {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String?
  email       String   @unique
  phoneNumber String
  password    String
  userType    UserType @default(SUPERADMIN)
  avatarUrl   String?

  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  storeId String?
  store   Store?  @relation("StoreToEmployees", fields: [storeId], references: [id])

  roleId String?
  role   Role?   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  refreshTokens   RefreshToken[]
  userPermissions UserPermission[]

  visibleEmployeeLinks EmployeeVisibility[] @relation("Viewer")
  visibleToLinks       EmployeeVisibility[] @relation("Target")

  managedStores Store[] @relation("StoreToManager")

  roleVisibilityTargets RoleUserVisibility[] @relation("RoleVisibilityTarget")

  appointments     Appointment[]
  clients          Client[]
  employeeServices EmployeeService[]
  schedulePattern   EmployeeSchedulePattern?
  workingSchedules  EmployeeWorkingSchedule[]

  @@map("users")
}

//
// =========================
//          STORE
// =========================
//

model Store {
  id          String   @id @default(cuid())
  name        String   @unique
  areaOfWork  String
  teamSize    Int
  date        String
  signature   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  companyId   String
  managerId   String
  phoneNumber String

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager   User?   @relation("StoreToManager", fields: [managerId], references: [id])
  employees User[]  @relation("StoreToEmployees")

  services         Service[]
  categories       Category[]
  clients          Client[]
  appointments     Appointment[]
  employeeServices EmployeeService[]

  @@map("stores")
}

//
// =========================
//   EMPLOYEE VISIBILITY
// =========================
//

model EmployeeVisibility {
  id       String @id @default(cuid())
  viewerId String
  targetId String

  viewer User @relation("Viewer", fields: [viewerId], references: [id], onDelete: Cascade)
  target User @relation("Target", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([viewerId, targetId])
  @@map("employee_visibility")
}

//
// =========================
//            ROLE
// =========================
//

model Role {
  id              String               @id @default(cuid())
  name            String               @unique
  description     String?
  userLimit       Int?                 @default(10)
  companyId       String?
  company         Company?             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users           User[]
  rolePermissions RolePermission[]
  visibilityRules RoleUserVisibility[]
}

model RoleUserVisibility {
  id       String @id @default(cuid())
  roleId   String
  targetId String

  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  target User @relation("RoleVisibilityTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([roleId, targetId])
  @@map("role_user_visibility")
}

//
// =========================
//         PERMISSIONS
// =========================
//

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  module          String
  action          String
  description     String?
  rolePermissions RolePermission[]
  userPermissions UserPermission[]
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

enum PermissionEffect {
  ALLOW
  DENY
}

model UserPermission {
  id           String           @id @default(cuid())
  userId       String
  permissionId String
  effect       PermissionEffect

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
}

//
// =========================
//      REFRESH TOKEN
// =========================
//

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//
// =========================
//         OTP CODES
// =========================
//

model OtpCode {
  id          Int      @id @default(autoincrement())
  code        String
  email       String?
  phoneNumber String?
  isUsed      Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

//
// =========================
//        CATEGORY
// =========================
//

model Category {
  id          String   @id @default(cuid())
  categoryId  String   @unique @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  services Service[]

  @@map("categories")
}

//
// =========================
//         SERVICE
// =========================
//

model Service {
  id              String   @id @default(cuid())
  serviceId       String   @unique @default(cuid()) @map("serviceid")
  name            String
  description     String?
  durationMinutes Int
  price           Json
  colorHex        String?
  deposit         Json
  isActive        Boolean  @default(true)
  date            String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  storeId    String @map("storeId")
  categoryId String @map("categoryid")

  store            Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category         Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  employeeServices EmployeeService[]
  AppointmentServices AppointmentService[]

  @@map("services")
}

//
// =========================
//       APPOINTMENTS
// =========================
//

model Appointment {
  id        String   @id @default(cuid())

  // ‚è∞ Time
  date      DateTime
  startTime DateTime
  endTime   DateTime

  color     String   @default("gold")

  // üîÅ Recurrence (ONLY thing in JSON)
  recurrence Json?   // null = one-time, object = recurring

  // üí∞ Payments
  downPayment  Float?
  totalPayment Float?

  // üì© SMS
  sendSms     Boolean @default(false)
  smsReminder String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relations (REAL FKs, NOT JSON)
  storeId String
  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  services AppointmentService[]

  @@map("appointments")
}


//
// ============================
//       APPOINTMENTS SERVICES
// ============================
//

model AppointmentService {
  id            String @id @default(cuid())
  appointmentId String
  serviceId     String

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, serviceId])
}


//
// =========================
//          CLIENT
// =========================
//

model Client {
  id          String    @id @default(cuid()) // Primary key
  clientId    String    @default(cuid()) // Local client ID (no longer globally unique!)
  name        String
  phone       String
  email       String?
  notes       String?
  birthday    DateTime?
  information Json? // Stores notes/history array
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userId  String
  storeId String

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  appointments Appointment[]

  @@unique([clientId, storeId])
  @@map("clients")
}

//
// ========================
//    EMOLYEE SERVICE
// ========================
//

model EmployeeService {
  id         String @id @default(cuid())
  employeeId String
  serviceId  String
  storeId    String

  createdAt DateTime @default(now())

  employee User    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  service  Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  store    Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, serviceId])
  @@map("employee_services")
}

//////////////////////////////////////
// ENUMS
//////////////////////////////////////

enum ScheduleMode {
  EVERY_WEEK
  RECURRING
}

//////////////////////////////////////
// SCHEDULE PATTERN (WHEN & HOW OFTEN)
//////////////////////////////////////

model EmployeeSchedulePattern {
  id          String       @id @default(cuid())
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  repeatEveryWeeks  Int      // 1 = every week, 4 = every 4 weeks
  startsAt    DateTime?    // required for RECURRING

  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
}

//////////////////////////////////////
// WEEKLY WORKING SCHEDULE (WHAT DAYS)
//////////////////////////////////////

model EmployeeWorkingSchedule {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  weekOffset Int     // 1..repeatEveryWeeks (e.g. 1‚Äì4)

  dayOfWeek Int      // 1 = Monday, 7 = Sunday
  isEnabled Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timeSlots EmployeeTimeSlot[]

  @@unique([userId, weekOffset, dayOfWeek])
}


//////////////////////////////////////
// TIME SLOTS (WHAT HOURS)
//////////////////////////////////////

model EmployeeTimeSlot {
  id          String   @id @default(cuid())
  scheduleId  String
  schedule    EmployeeWorkingSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  startTime   String   // "09:00"
  endTime     String   // "17:30"

  createdAt   DateTime @default(now())
}
